name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  # Create GitHub Release
  create-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get release notes
      id: release-notes
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # Generate release notes
        echo "Creating release for version $VERSION"

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## ðŸš€ Release ${{ github.ref_name }}

          ### What's New
          - Complete To-Do List application with authentication
          - Microservices architecture (React + Node.js + Python)
          - Docker containerization
          - Comprehensive testing suite

          ### Features
          - âœ… User registration and login
          - âœ… JWT-based authentication
          - âœ… Personal task management
          - âœ… Docker deployment
          - âœ… CI/CD pipelines

          ### Quick Start
          ```bash
          # Clone the repository
          git clone https://github.com/Sibi-Sebastian/Todo-List-App.git
          cd Todo-List-App

          # Run with Docker
          docker-compose up --build -d

          # Access the application
          open http://localhost:3000
          ```

        draft: false
        prerelease: false

  # Build and Release Docker Images with Version Tags
  release-docker-images:
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/todo-app-frontend:${{ env.VERSION }}
          ${{ secrets.DOCKERHUB_USERNAME }}/todo-app-frontend:latest
        labels: |
          org.opencontainers.image.title=Todo App Frontend
          org.opencontainers.image.version=${{ env.VERSION }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push task service image
      uses: docker/build-push-action@v5
      with:
        context: ./backend/task-service
        file: ./backend/task-service/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/todo-app-task-service:${{ env.VERSION }}
          ${{ secrets.DOCKERHUB_USERNAME }}/todo-app-task-service:latest
        labels: |
          org.opencontainers.image.title=Todo App Task Service
          org.opencontainers.image.version=${{ env.VERSION }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push user service image
      uses: docker/build-push-action@v5
      with:
        context: ./backend/user-service
        file: ./backend/user-service/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/todo-app-user-service:${{ env.VERSION }}
          ${{ secrets.DOCKERHUB_USERNAME }}/todo-app-user-service:latest
        labels: |
          org.opencontainers.image.title=Todo App User Service
          org.opencontainers.image.version=${{ env.VERSION }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
